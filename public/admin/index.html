<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>七糯糯的小站 - 內容管理</title>
    <!-- Tell Decap CMS where to find the config file -->
    <link href="config.yml" type="text/yaml" rel="cms-config-url">
    
    <!-- Custom Styling -->
    <link rel="stylesheet" href="admin.css">
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">
    <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>

    <script type="module">
        import Markdown from 'https://esm.sh/react-markdown@9?bundle'
        import remarkMath from 'https://esm.sh/remark-math@6.0.0?bundle'
        import rehypeMathjax from 'https://esm.sh/rehype-mathjax@5.0.0?bundle'
        import rehypeRaw from 'https://esm.sh/rehype-raw@7.0.0?bundle'

        const renderMarkdownWithMath = (markdown) => {
          // Use react-markdown with remark/rehype to display LaTeX in the preview pane.
          // rehypeRaw allows HTML to be rendered properly
          return window.h(Markdown, {
            remarkPlugins: [remarkMath],
            rehypePlugins: [rehypeRaw, rehypeMathjax],
            children: markdown || ''
          });
        };
        window.renderMarkdownWithMath = renderMarkdownWithMath;
        
        var PostPreview = createClass({
        render: function() {
            var entryBody = (this.props.widgetFor('body') === null) ? ' ' : this.props.widgetFor('body').props.value;
            return Markdown({
            children: entryBody,
            rehypePlugins: [rehypeRaw, rehypeMathjax],
            remarkPlugins: [remarkMath]
            });
        }
        });
        CMS.registerPreviewTemplate("posts", PostPreview);
    </script>
    
    <!-- Custom widgets and initialization -->
    <script>
      const ensurePreviewStyles = () => {
        if (!window.CMS) return;
        try {
          window.CMS.registerPreviewStyle('admin.css');
        } catch (e) {
          console.warn('Failed to register preview style', e);
        }
      };

      if (window.CMS) {
        ensurePreviewStyles();
      } else {
        document.addEventListener('CMSLoaded', ensurePreviewStyles);
      }

      // Wait for CMS to be available
      if (window.CMS) {
        if (typeof window.renderMarkdownWithMath !== 'function') {
          // Provide a simple fallback until the math-enabled renderer is ready.
          window.renderMarkdownWithMath = (markdown) => window.h('div', {}, markdown || '');
        }
        const ImageCropperControl = window.createClass({
          getInitialState() {
            return {
              imageUrl: this.props.value || '',
              showCropper: false,
              cropper: null,
              lastMediaPath: null
            };
          },

          componentDidUpdate(prevProps) {
            // Detect selection from Decap Media Library
            const getForIdPath = (props) => {
              const mp = props.mediaPaths;
              if (!mp) return null;
              try {
                if (typeof mp.get === 'function') return mp.get(props.forID) || null;
                return mp[props.forID] || null;
              } catch (e) { return null; }
            };

            const selectedPath = getForIdPath(this.props);
            const prevPath = getForIdPath(prevProps);
            if (selectedPath && selectedPath !== prevPath && selectedPath !== this.state.lastMediaPath) {
              // Use the chosen asset immediately (persistent path), allow optional cropping
              this.setState({ imageUrl: selectedPath, lastMediaPath: selectedPath, showCropper: false });
              if (typeof this.props.onChange === 'function') {
                this.props.onChange(selectedPath);
              }
              // Clear the selection so future picks are detected
              if (typeof this.props.onClearMediaControl === 'function') {
                this.props.onClearMediaControl(this.props.forID);
              }
            }
          },

          componentWillUnmount() {
            if (this.state.cropper) {
              this.state.cropper.destroy();
            }
          },

          handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              this.setState({ 
                imageUrl: event.target.result,
                showCropper: true 
              }, () => {
                this.initCropper();
              });
            };
            reader.readAsDataURL(file);
          },

          initCropper() {
            const image = document.getElementById('crop-image-preview');
            if (!image || !window.Cropper) return;

            if (this.state.cropper) {
              this.state.cropper.destroy();
            }

            const cropper = new Cropper(image, {
              aspectRatio: 1, // Square for avatar
              viewMode: 1,
              dragMode: 'move',
              autoCropArea: 1,
              restore: false,
              guides: true,
              center: true,
              highlight: false,
              cropBoxMovable: true,
              cropBoxResizable: true,
              toggleDragModeOnDblclick: false,
            });

            this.setState({ cropper });
          },

          handleCrop() {
            if (!this.state.cropper) return;

            const canvas = this.state.cropper.getCroppedCanvas({
              width: 400,
              height: 400,
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });

            canvas.toBlob(async (blob) => {
              if (!blob) return;

              // Create a unique filename to avoid collisions
              const filename = `avatar-${Date.now()}.jpg`;
              const file = new File([blob], filename, { type: 'image/jpeg' });

              try {
                // Upload to Decap CMS media library (configured via media_folder/public_folder)
                const added = await this.props.onAddAsset(file);

                // Determine a persistent URL/path for storing in the field
                const value = (added && (added.url || added.path || (added.toString && added.toString()))) || null;

                if (value) {
                  this.setState({ 
                    imageUrl: value,
                    showCropper: false 
                  });
                  this.props.onChange(value);
                } else {
                  // Fallback to preview only if asset didn't return a path (shouldn't happen normally)
                  const previewUrl = URL.createObjectURL(blob);
                  this.setState({ imageUrl: previewUrl, showCropper: false });
                }
              } catch (e) {
                console.error('Image upload failed:', e);
                const previewUrl = URL.createObjectURL(blob);
                this.setState({ imageUrl: previewUrl, showCropper: false });
              }
            }, 'image/jpeg', 0.9);
          },

          handleCancel() {
            if (this.state.cropper) {
              this.state.cropper.destroy();
            }
            this.setState({ showCropper: false });
          },

          handleUrlInput() {
            const url = prompt('輸入圖片網址：');
            if (url) {
              this.setState({ imageUrl: url });
              this.props.onChange(url);
            }
          },

          openMediaLibrary() {
            if (typeof this.props.onOpenMediaLibrary === 'function') {
              this.props.onOpenMediaLibrary({ controlID: this.props.forID, forImage: true });
            }
          },

          render() {
            const { imageUrl, showCropper } = this.state;
            const { forID } = this.props;

            return window.h('div', { className: 'image-cropper-widget' },
              // Current image preview
              imageUrl && !showCropper ? window.h('div', { style: { marginBottom: '1rem' } },
                window.h('img', {
                  src: imageUrl,
                  alt: 'Preview',
                  style: {
                    width: '150px',
                    height: '150px',
                    objectFit: 'cover',
                    borderRadius: '50%',
                    border: '3px solid #7dd3fc',
                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                  }
                })
              ) : null,

              // File input button (hidden, styled button triggers it)
              window.h('input', {
                id: forID,
                type: 'file',
                accept: 'image/*',
                onChange: this.handleFileSelect,
                style: { display: 'none' }
              }),

              // Upload button
              !showCropper ? window.h('div', {
                style: {
                  display: 'flex',
                  gap: '0.5rem',
                  flexWrap: 'wrap'
                }
              },
                window.h('button', {
                  type: 'button',
                  onClick: () => document.getElementById(forID).click(),
                  style: {
                    padding: '0.5rem 1rem',
                    background: '#0ea5e9',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }
                }, imageUrl ? '更換圖片' : '上傳圖片'),
                window.h('button', {
                  type: 'button',
                  onClick: this.openMediaLibrary,
                  style: {
                    padding: '0.5rem 1rem',
                    background: '#38bdf8',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }
                }, '從媒體庫選擇'),
                imageUrl ? window.h('button', {
                  type: 'button',
                  onClick: () => this.setState({ showCropper: true }, () => this.initCropper()),
                  style: {
                    padding: '0.5rem 1rem',
                    background: '#10b981',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }
                }, '裁切這張圖片') : null,
                window.h('button', {
                  type: 'button',
                  onClick: this.handleUrlInput,
                  style: {
                    padding: '0.5rem 1rem',
                    background: '#64748b',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }
                }, '從網址新增')
              ) : null,

              // Cropper modal
              showCropper ? window.h('div', {
                style: {
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0, 0, 0, 0.8)',
                  zIndex: 9999,
                  display: 'flex',
                  flexDirection: 'column',
                  padding: '2rem'
                }
              },
                window.h('div', { 
                  style: { 
                    flex: 1, 
                    marginBottom: '1rem',
                    maxHeight: '70vh',
                    overflow: 'hidden'
                  }
                },
                  window.h('img', {
                    id: 'crop-image-preview',
                    src: imageUrl,
                    style: { maxWidth: '100%', display: 'block' }
                  })
                ),
                window.h('div', { 
                  style: { 
                    display: 'flex', 
                    gap: '1rem', 
                    justifyContent: 'center' 
                  }
                },
                  window.h('button', {
                    onClick: this.handleCrop,
                    style: {
                      padding: '0.75rem 1.5rem',
                      background: '#10b981',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      fontSize: '1rem'
                    }
                  }, '裁切並儲存'),
                  window.h('button', {
                    onClick: this.handleCancel,
                    style: {
                      padding: '0.75rem 1.5rem',
                      background: '#ef4444',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      fontSize: '1rem'
                    }
                  }, '取消')
                )
              ) : null
            );
          }
        });

        const ImageCropperPreview = window.createClass({
          render() {
            const { value } = this.props;
            if (!value) return null;

            return window.h('div', { style: { textAlign: 'center', padding: '1rem' } },
              window.h('img', {
                src: value,
                alt: 'Avatar Preview',
                style: {
                  width: '120px',
                  height: '120px',
                  objectFit: 'cover',
                  borderRadius: '50%',
                  border: '3px solid #0ea5e9',
                  boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                }
              })
            );
          }
        });

        // Register the custom widget
        window.CMS.registerWidget('image-cropper', ImageCropperControl, ImageCropperPreview);

        // Resolve getAsset (returns a Promise in Decap CMS 2.10+) for draft/new uploads
        const resolveAsset = (getAsset, value, setStateKey, component) => {
          if (!value) {
            component.setState({ [setStateKey]: null });
            return;
          }
          const p = getAsset(value);
          if (p && typeof p.then === 'function') {
            p.then(function(url) {
              const u = url != null ? (typeof url === 'string' ? url : (url.url || url.toString && url.toString())) : null;
              component.setState({ [setStateKey]: u });
            }).catch(function() { component.setState({ [setStateKey]: null }); });
          } else {
            component.setState({ [setStateKey]: p != null ? (typeof p === 'string' ? p : p.toString()) : null });
          }
        };

        // Blog Post Preview Template
        const BlogPostPreview = window.createClass({
          getInitialState() {
            return { featuredImageUrl: null };
          },
          componentDidMount() {
            const featuredImage = this.props.entry.getIn(['data', 'featured_image']);
            resolveAsset(this.props.getAsset, featuredImage, 'featuredImageUrl', this);
          },
          componentDidUpdate(prevProps) {
            const curr = this.props.entry.getIn(['data', 'featured_image']);
            const prev = prevProps.entry.getIn(['data', 'featured_image']);
            if (curr !== prev) {
              resolveAsset(this.props.getAsset, curr, 'featuredImageUrl', this);
            }
          },
          render() {
            const { entry, widgetFor, getAsset } = this.props;
            const title = entry.getIn(['data', 'title']);
            const description = entry.getIn(['data', 'description']);
            const date = entry.getIn(['data', 'date']);
            const author = entry.getIn(['data', 'author']);
            const tags = entry.getIn(['data', 'tags']);
            const series = entry.getIn(['data', 'series']);
            const bodyWidget = widgetFor('body');
            const bodyMarkdown = bodyWidget && bodyWidget.props && typeof bodyWidget.props.value === 'string'
              ? bodyWidget.props.value
              : (entry.getIn(['data', 'body']) || '');

            const imageUrl = this.state.featuredImageUrl;

            return window.h('div', { 
              style: { 
                maxWidth: '900px', 
                margin: '0 auto',
                fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif'
              } 
            },
              // Card Preview (how it looks on homepage)
              title ? window.h('div', {
                style: {
                  marginBottom: '2rem',
                  padding: '1.5rem',
                  background: '#f8fafc',
                  borderRadius: '12px',
                  border: '1px solid #e2e8f0'
                }
              },
                window.h('div', {
                  style: {
                    fontSize: '0.75rem',
                    fontWeight: '600',
                    color: '#64748b',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    marginBottom: '1rem',
                    fontFamily: 'DM Sans, -apple-system, BlinkMacSystemFont, sans-serif'
                  }
                }, '文章卡片預覽 (首頁顯示)'),
                window.h('div', {
                  style: {
                    background: '#ffffff',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    border: '1px solid #e2e8f0',
                    boxShadow: '0 1px 2px 0 rgb(0 0 0 / 0.05)',
                    transition: 'all 0.2s ease'
                  }
                },
                  imageUrl ? window.h('div', {
                    style: {
                      width: '100%',
                      height: '200px',
                      background: `url(${imageUrl}) center/cover`,
                      borderBottom: '1px solid #e2e8f0'
                    }
                  }) : window.h('div', {
                    style: {
                      width: '100%',
                      height: '200px',
                      background: '#f1f5f9',
                      borderBottom: '1px solid #e2e8f0',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: '#94a3b8',
                      fontSize: '0.9rem',
                      fontWeight: '500',
                      fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif'
                    }
                  }, '圖片預覽'),
                  window.h('div', { style: { padding: '1.5rem' } },
                    window.h('h3', {
                      style: {
                        fontFamily: 'DM Sans, -apple-system, BlinkMacSystemFont, sans-serif',
                        fontSize: '1.25rem',
                        fontWeight: '600',
                        color: '#1e293b',
                        marginBottom: '0.5rem',
                        lineHeight: '1.4'
                      }
                    }, title),
                    description ? window.h('p', {
                      style: {
                        fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                        fontSize: '0.9rem',
                        color: '#64748b',
                        lineHeight: '1.6',
                        marginBottom: '1rem'
                      }
                    }, description.length > 100 ? description.substring(0, 100) + '...' : description) : null,
                    window.h('div', {
                      style: {
                        fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '1rem',
                        fontSize: '0.85rem',
                        color: '#64748b'
                      }
                    },
                      window.h('span', {}, `${author || 'Anonymous'}`),
                      date ? window.h('span', {}, `${new Date(date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}`) : null
                    )
                  )
                )
              ) : null,

              // Full Post Preview
              window.h('div', {
              style: {
                fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                maxWidth: '720px',
                margin: '0 auto',
                padding: '3rem',
                background: '#ffffff',
                borderRadius: '12px',
                boxShadow: '0 1px 2px 0 rgb(0 0 0 / 0.05)',
                border: '1px solid #e2e8f0'
              }
            },
              // Post Header
              window.h('div', {
                style: {
                  marginBottom: '2rem',
                  paddingBottom: '1rem',
                  borderBottom: '2px solid #e2e8f0'
                }
              },
                // Title
                window.h('h1', {
                  style: {
                    fontFamily: 'DM Sans, -apple-system, BlinkMacSystemFont, sans-serif',
                    fontSize: '2.5rem',
                    fontWeight: '700',
                    color: '#1e293b',
                    lineHeight: '1.2',
                    marginBottom: '0.75rem'
                  }
                }, title),

                // Meta bar
                window.h('div', {
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '1.5rem',
                    flexWrap: 'wrap',
                    marginBottom: '1rem'
                  }
                },
                  // Author info (placeholder)
                  window.h('div', {
                    style: {
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem'
                    }
                  },
                    window.h('div', {
                      style: {
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        background: '#7dd3fc',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontWeight: '600',
                        color: '#0284c7',
                        border: '2px solid #7dd3fc'
                      }
                    }, author ? author.charAt(0) : 'A'),
                    window.h('span', {
                      style: {
                        fontWeight: '600',
                        color: '#1e293b',
                        fontSize: '0.95rem'
                      }
                    }, author || 'Anonymous')
                  ),
                  // Divider
                  window.h('div', {
                    style: {
                      width: '1px',
                      height: '24px',
                      background: '#cbd5e1'
                    }
                  }),
                  // Date
                  window.h('div', {
                    style: {
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.4rem',
                      fontSize: '0.9rem',
                      color: '#64748b'
                    }
                  }, 
                    date ? new Date(date).toLocaleDateString('zh-TW', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    }) : ''
                  )
                ),

                // Tags
                tags && tags.size > 0 ? window.h('div', {
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.75rem',
                    marginTop: '1rem'
                  }
                },
                  window.h('div', {
                    style: {
                      display: 'flex',
                      flexWrap: 'wrap',
                      gap: '0.5rem'
                    }
                  }, tags.map(tag => 
                    window.h('span', {
                      key: tag,
                      style: {
                        padding: '0.35rem 0.75rem',
                        background: '#f0f9ff',
                        color: '#0ea5e9',
                        borderRadius: '16px',
                        fontSize: '0.85rem',
                        fontWeight: '500',
                        border: '1px solid #7dd3fc'
                      }
                    }, tag)
                  ).toArray())
                ) : null,

                // Series badges
                series && series.size > 0 ? window.h('div', {
                  style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    marginTop: tags && tags.size > 0 ? '0.5rem' : '1rem',
                    flexWrap: 'wrap'
                  }
                },
                  window.h('span', {
                    style: {
                      fontSize: '0.8rem',
                      color: '#64748b',
                      fontWeight: '600'
                    }
                  }, '專欄：'),
                  series.map(s =>
                    window.h('span', {
                      key: s,
                      style: {
                        display: 'inline-flex',
                        alignItems: 'center',
                        gap: '0.25rem',
                        padding: '0.35rem 0.75rem',
                        background: 'rgba(14, 165, 233, 0.08)',
                        color: '#0284c7',
                        borderRadius: '16px',
                        fontSize: '0.85rem',
                        fontWeight: '500',
                        border: '1px solid rgba(14, 165, 233, 0.2)'
                      }
                    }, '\u{1F4D1} ' + s)
                  ).toArray()
                ) : null
              ),

              // Featured image
              imageUrl ? window.h('div', {
                style: {
                  marginBottom: '2.5rem',
                  borderRadius: '12px',
                  overflow: 'hidden',
                  boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                }
              }, window.h('img', {
                src: imageUrl,
                alt: title,
                style: {
                  width: '100%',
                  height: 'auto',
                  display: 'block'
                }
              })) : null,

              // Body content
              window.h('div', {
                style: {
                  fontSize: '1.05rem',
                  lineHeight: '1.8',
                  color: '#1e293b'
                },
                className: 'blog-preview-content'
              }, window.renderMarkdownWithMath(bodyMarkdown))
            )
            );
          }
        });

        // Author Preview Template - matches the actual /author/[name] page layout
        const AuthorPreview = window.createClass({
          getInitialState() {
            return { avatarUrl: null, bannerUrl: null };
          },
          componentDidMount() {
            const avatar = this.props.entry.getIn(['data', 'avatar']);
            const banner = this.props.entry.getIn(['data', 'banner']);
            resolveAsset(this.props.getAsset, avatar, 'avatarUrl', this);
            resolveAsset(this.props.getAsset, banner, 'bannerUrl', this);
          },
          componentDidUpdate(prevProps) {
            const entry = this.props.entry;
            const prev = prevProps.entry;
            if (entry.getIn(['data', 'avatar']) !== prev.getIn(['data', 'avatar'])) {
              resolveAsset(this.props.getAsset, entry.getIn(['data', 'avatar']), 'avatarUrl', this);
            }
            if (entry.getIn(['data', 'banner']) !== prev.getIn(['data', 'banner'])) {
              resolveAsset(this.props.getAsset, entry.getIn(['data', 'banner']), 'bannerUrl', this);
            }
          },
          render() {
            const { entry, getAsset, widgetFor } = this.props;
            const name = entry.getIn(['data', 'name']);
            const bio = entry.getIn(['data', 'bio']);
            const email = entry.getIn(['data', 'email']);
            const avatar = entry.getIn(['data', 'avatar']);
            const banner = entry.getIn(['data', 'banner']);
            const social = entry.getIn(['data', 'social']);
            const bodyWidget = widgetFor('body');
            const bodyMarkdown = bodyWidget && bodyWidget.props && typeof bodyWidget.props.value === 'string'
              ? bodyWidget.props.value
              : (entry.getIn(['data', 'body']) || '');

            const avatarUrl = this.state.avatarUrl;
            const bannerUrl = this.state.bannerUrl;
            const hasBody = bodyMarkdown && bodyMarkdown.trim().length > 0;

            // Helper: build an SVG icon as inline data URI
            const svgIcon = (pathD, viewBox = '0 0 24 24') => {
              const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${viewBox}" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">${pathD}</svg>`;
              return 'data:image/svg+xml,' + encodeURIComponent(svg);
            };

            const envelopeIcon = svgIcon('<rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>');
            const linkIcon = svgIcon('<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>');
            const githubIcon = svgIcon('<path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/>');
            const twitterIcon = svgIcon('<path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/>');
            const docIcon = svgIcon('<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>');

            // Link item helper
            const linkItem = (iconSrc, text, href) => {
              return window.h('a', {
                href: href || '#',
                target: href && href.startsWith('http') ? '_blank' : undefined,
                style: {
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  padding: '0.4rem 0.6rem',
                  borderRadius: '8px',
                  fontSize: '0.85rem',
                  color: '#475569',
                  textDecoration: 'none',
                  transition: 'all 0.15s ease'
                }
              },
                window.h('img', { src: iconSrc, style: { width: '16px', height: '16px', opacity: 0.5 } }),
                window.h('span', { style: { overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, text)
              );
            };

            return window.h('div', {
              style: {
                fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                maxWidth: '1100px',
                margin: '0 auto',
                padding: '0'
              }
            },
              // ===== Banner Section =====
              bannerUrl
                ? window.h('div', {
                    style: {
                      width: '100%',
                      height: '200px',
                      borderRadius: '0 0 16px 16px',
                      overflow: 'hidden'
                    }
                  },
                    window.h('img', {
                      src: bannerUrl,
                      alt: name + ' banner',
                      style: { width: '100%', height: '100%', objectFit: 'cover', display: 'block' }
                    })
                  )
                : window.h('div', {
                    style: {
                      width: '100%',
                      height: '200px',
                      borderRadius: '0 0 16px 16px',
                      background: 'linear-gradient(135deg, rgba(14,165,233,0.3) 0%, rgba(251,191,36,0.2) 50%, rgba(125,211,252,0.25) 100%)',
                      position: 'relative'
                    }
                  },
                    window.h('div', {
                      style: {
                        position: 'absolute',
                        inset: '0',
                        backgroundImage: 'radial-gradient(circle at 20% 50%, rgba(14,165,233,0.15) 0%, transparent 50%), radial-gradient(circle at 80% 30%, rgba(251,191,36,0.12) 0%, transparent 50%)'
                      }
                    })
                  ),

              // ===== Main Layout: Profile LEFT, Content RIGHT =====
              window.h('div', {
                style: {
                  display: 'grid',
                  gridTemplateColumns: '300px minmax(0, 1fr)',
                  gap: '2rem',
                  alignItems: 'start',
                  paddingTop: '1.25rem'
                }
              },
                // ===== Left Column: Profile Sidebar =====
                window.h('aside', {
                  style: {
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '0.85rem'
                  }
                },
                  // Profile Card
                  window.h('div', {
                    style: {
                      background: '#ffffff',
                      border: '1px solid #e2e8f0',
                      borderRadius: '14px',
                      padding: '0 1.25rem 1.25rem',
                      boxShadow: '0 1px 2px 0 rgb(0 0 0 / 0.05)',
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '0.6rem'
                    }
                  },
                    // Avatar overlapping banner
                    window.h('div', {
                      style: {
                        width: '96px',
                        height: '96px',
                        borderRadius: '50%',
                        overflow: 'hidden',
                        border: '4px solid #ffffff',
                        boxShadow: '0 0 0 2px #0ea5e9',
                        marginTop: '-48px',
                        flexShrink: '0',
                        background: '#ffffff'
                      }
                    },
                      avatarUrl
                        ? window.h('img', {
                            src: avatarUrl,
                            alt: name,
                            style: { width: '100%', height: '100%', objectFit: 'cover' }
                          })
                        : window.h('div', {
                            style: {
                              width: '100%',
                              height: '100%',
                              background: '#7dd3fc',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '2.5rem',
                              fontWeight: '700',
                              color: '#0284c7'
                            }
                          }, name ? name.charAt(0) : 'A')
                    ),

                    // Name
                    window.h('h1', {
                      style: {
                        fontFamily: 'DM Sans, -apple-system, BlinkMacSystemFont, sans-serif',
                        fontSize: '1.4rem',
                        fontWeight: '700',
                        color: '#1e293b',
                        margin: '0',
                        textAlign: 'center'
                      }
                    }, name),

                    // Bio
                    bio ? window.h('p', {
                      style: {
                        fontSize: '0.9rem',
                        color: '#64748b',
                        lineHeight: '1.6',
                        margin: '0',
                        textAlign: 'center'
                      }
                    }, bio) : null,

                    // Stats row (placeholder with zeros since we can't query posts)
                    window.h('div', {
                      style: {
                        display: 'flex',
                        gap: '1.25rem',
                        padding: '0.75rem 0',
                        borderTop: '1px solid #e2e8f0',
                        borderBottom: '1px solid #e2e8f0',
                        width: '100%',
                        justifyContent: 'center'
                      }
                    },
                      ['文章', '標籤', '專欄'].map((label, i) =>
                        window.h('div', {
                          key: label,
                          style: {
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.3rem',
                            fontSize: '0.85rem',
                            color: '#64748b'
                          }
                        },
                          window.h('span', { style: { fontWeight: '700', color: '#1e293b' } }, '-'),
                          window.h('span', { style: { color: '#94a3b8' } }, label)
                        )
                      )
                    ),

                    // Contact & Links
                    (email || (social && social.size > 0))
                      ? window.h('div', {
                          style: {
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '0.3rem',
                            width: '100%'
                          }
                        },
                          email ? linkItem(envelopeIcon, email, 'mailto:' + email) : null,
                          social && social.get('website') ? linkItem(linkIcon, social.get('website').replace(/^https?:\/\//, ''), social.get('website')) : null,
                          social && social.get('github') ? linkItem(githubIcon, 'GitHub', social.get('github')) : null,
                          social && social.get('twitter') && social.get('twitter') !== '' ? linkItem(twitterIcon, 'Twitter', social.get('twitter')) : null
                        )
                      : null
                  )
                ),

                // ===== Right Column: Tab bar + README content =====
                window.h('main', {
                  style: { minWidth: '0' }
                },
                  // Tab bar
                  window.h('div', {
                    style: {
                      display: 'flex',
                      gap: '0',
                      borderBottom: '2px solid #e2e8f0',
                      marginBottom: '1.25rem'
                    }
                  },
                    // Posts tab (inactive in preview)
                    window.h('button', {
                      style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.4rem',
                        padding: '0.75rem 1.25rem',
                        fontSize: '0.95rem',
                        fontWeight: '600',
                        color: '#94a3b8',
                        background: 'none',
                        border: 'none',
                        cursor: 'default',
                        borderBottom: '2px solid transparent',
                        marginBottom: '-2px'
                      }
                    }, '文章', window.h('span', {
                      style: {
                        fontSize: '0.78rem',
                        fontWeight: '700',
                        background: '#f1f5f9',
                        border: '1px solid #e2e8f0',
                        padding: '0.1rem 0.45rem',
                        borderRadius: '999px',
                        color: '#94a3b8'
                      }
                    }, '-')),
                    // README tab (active in preview)
                    window.h('button', {
                      style: {
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.4rem',
                        padding: '0.75rem 1.25rem',
                        fontSize: '0.95rem',
                        fontWeight: '600',
                        color: '#1e293b',
                        background: 'none',
                        border: 'none',
                        cursor: 'default',
                        borderBottom: '2px solid #0ea5e9',
                        marginBottom: '-2px'
                      }
                    }, 'README')
                  ),

                  // README card
                  hasBody
                    ? window.h('div', {
                        style: {
                          background: '#ffffff',
                          border: '1px solid #e2e8f0',
                          borderRadius: '12px',
                          overflow: 'hidden',
                          boxShadow: '0 1px 2px 0 rgb(0 0 0 / 0.05)'
                        }
                      },
                        // README header (GitHub-style)
                        window.h('div', {
                          style: {
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.6rem',
                            padding: '0.75rem 1.25rem',
                            borderBottom: '1px solid #e2e8f0',
                            background: '#f8fafc'
                          }
                        },
                          avatarUrl
                            ? window.h('img', {
                                src: avatarUrl,
                                alt: name,
                                style: {
                                  width: '22px',
                                  height: '22px',
                                  borderRadius: '50%',
                                  objectFit: 'cover'
                                }
                              })
                            : window.h('div', {
                                style: {
                                  width: '22px',
                                  height: '22px',
                                  borderRadius: '50%',
                                  background: '#7dd3fc',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  fontSize: '0.7rem',
                                  fontWeight: '700',
                                  color: '#0284c7'
                                }
                              }, name ? name.charAt(0) : 'A'),
                          window.h('span', {
                            style: {
                              fontSize: '0.88rem',
                              fontWeight: '600',
                              color: '#1e293b'
                            }
                          }, (name || 'Author') + ' / README.md')
                        ),
                        // README body with rendered markdown
                        window.h('div', {
                          style: {
                            padding: '1.5rem',
                            fontSize: '1rem',
                            lineHeight: '1.8',
                            color: '#1e293b'
                          },
                          className: 'author-readme-content'
                        }, window.renderMarkdownWithMath(bodyMarkdown))
                      )
                    : window.h('div', {
                        style: {
                          textAlign: 'center',
                          padding: '4rem 1rem',
                          color: '#94a3b8'
                        }
                      },
                        window.h('img', { src: svgIcon('<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>'), style: { width: '48px', height: '48px', opacity: 0.4, marginBottom: '1rem' } }),
                        window.h('p', { style: { margin: '0', fontSize: '0.95rem' } }, '此作者還沒有撰寫自我介紹。')
                      )
                )
              )
            );
          }
        });

        // Register preview templates
        window.CMS.registerPreviewTemplate('blog', BlogPostPreview);
        window.CMS.registerPreviewTemplate('authors', AuthorPreview);

        // Info Box Component
        window.CMS.registerEditorComponent({
          id: 'info-box',
          label: '資訊框',
          fields: [
            {
              name: 'type',
              label: '類型',
              widget: 'select',
              options: ['info', 'success', 'warning', 'error']
            },
            {
              name: 'title',
              label: '標題',
              widget: 'string'
            },
            {
              name: 'content',
              label: '內容',
              widget: 'text'
            }
          ],
          pattern: /^<div class="info-box info-box-(\w+)">\s*<strong>(.*?)<\/strong>\s*<p>(.*?)<\/p>\s*<\/div>$/ms,
          fromBlock: function(match) {
            return {
              type: match[1],
              title: match[2],
              content: match[3]
            };
          },
          toBlock: function(data) {
            return `<div class="info-box info-box-${data.type}">
  <strong>${data.title}</strong>
  <p>${data.content}</p>
</div>`;
          },
          toPreview: function(data) {
            const colors = {
              info: { bg: '#e0f2fe', border: '#0ea5e9', text: '#0284c7' },
              success: { bg: '#d1fae5', border: '#10b981', text: '#059669' },
              warning: { bg: '#fef3c7', border: '#f59e0b', text: '#d97706' },
              error: { bg: '#fee2e2', border: '#ef4444', text: '#dc2626' }
            };
            const color = colors[data.type] || colors.info;
            
            return `<div style="background: ${color.bg}; border-left: 4px solid ${color.border}; padding: 1rem 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
  <strong style="color: ${color.text}; display: block; margin-bottom: 0.5rem; font-size: 1.1rem;">${data.title}</strong>
  <p style="color: ${color.text}; margin: 0; line-height: 1.6;">${data.content}</p>
</div>`;
          }
        });

        // YouTube Video Component
        window.CMS.registerEditorComponent({
          id: 'youtube',
          label: 'YouTube 影片',
          fields: [
            {
              name: 'id',
              label: 'YouTube 影片 ID',
              widget: 'string'
            }
          ],
          pattern: /^<div class="youtube-embed"><iframe src="https:\/\/www\.youtube\.com\/embed\/([\w-]+)".*?<\/iframe><\/div>$/,
          fromBlock: function(match) {
            return {
              id: match[1]
            };
          },
          toBlock: function(data) {
            return `<div class="youtube-embed"><iframe src="https://www.youtube.com/embed/${data.id}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
          },
          toPreview: function(data) {
            return `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1.5rem 0; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
  <iframe src="https://www.youtube.com/embed/${data.id}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
</div>`;
          }
        });

        // Code Block with Language
        window.CMS.registerEditorComponent({
          id: 'code-block',
          label: '程式碼區塊',
          fields: [
            {
              name: 'language',
              label: '程式語言',
              widget: 'select',
              options: ['javascript', 'python', 'html', 'css', 'bash', 'json', 'yaml', 'markdown', 'typescript', 'vue', 'react']
            },
            {
              name: 'code',
              label: '程式碼',
              widget: 'text'
            }
          ],
          pattern: /^```(\w+)\n([\s\S]*?)\n```$/,
          fromBlock: function(match) {
            return {
              language: match[1],
              code: match[2]
            };
          },
          toBlock: function(data) {
            return `\`\`\`${data.language}\n${data.code}\n\`\`\``;
          },
          toPreview: function(data) {
            return `<pre style="background: #1e293b; color: #e2e8f0; padding: 1.5rem; border-radius: 8px; overflow-x: auto; margin: 1.5rem 0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);"><code>${data.code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
          }
        });

        // Image with Caption
        window.CMS.registerEditorComponent({
          id: 'image-caption',
          label: '圖片（帶說明）',
          fields: [
            {
              name: 'image',
              label: '圖片',
              widget: 'image'
            },
            {
              name: 'alt',
              label: '替代文字',
              widget: 'string'
            },
            {
              name: 'caption',
              label: '圖片說明',
              widget: 'string',
              required: false
            }
          ],
          pattern: /^<figure>\s*<img src="(.+?)" alt="(.+?)".*?>\s*(?:<figcaption>(.*?)<\/figcaption>)?\s*<\/figure>$/,
          fromBlock: function(match) {
            return {
              image: match[1],
              alt: match[2],
              caption: match[3] || ''
            };
          },
          toBlock: function(data) {
            const caption = data.caption ? `\n  <figcaption>${data.caption}</figcaption>` : '';
            return `<figure>
  <img src="${data.image}" alt="${data.alt}">${caption}
</figure>`;
          },
          toPreview: function(data) {
            const caption = data.caption ? `<figcaption style="text-align: center; color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; font-style: italic;">${data.caption}</figcaption>` : '';
            return `<figure style="margin: 1.5rem 0;">
  <img src="${data.image}" alt="${data.alt}" style="width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
  ${caption}
</figure>`;
          }
        });

        // Quote with Author
        window.CMS.registerEditorComponent({
          id: 'quote-author',
          label: '引言（帶作者）',
          fields: [
            {
              name: 'quote',
              label: '引言內容',
              widget: 'text'
            },
            {
              name: 'author',
              label: '作者',
              widget: 'string',
              required: false
            }
          ],
          pattern: /^<blockquote>\s*<p>(.*?)<\/p>\s*(?:<cite>— (.*?)<\/cite>)?\s*<\/blockquote>$/ms,
          fromBlock: function(match) {
            return {
              quote: match[1],
              author: match[2] || ''
            };
          },
          toBlock: function(data) {
            const author = data.author ? `\n  <cite>— ${data.author}</cite>` : '';
            return `<blockquote>
  <p>${data.quote}</p>${author}
</blockquote>`;
          },
          toPreview: function(data) {
            const author = data.author ? `<cite style="display: block; margin-top: 0.5rem; font-style: normal; color: #64748b;">— ${data.author}</cite>` : '';
            return `<blockquote style="border-left: 4px solid #f97316; padding: 1rem 1.5rem; margin: 1.5rem 0; background: #f8fafc; border-radius: 0 8px 8px 0;">
  <p style="font-style: italic; color: #1e293b; margin: 0; line-height: 1.6;">${data.quote}</p>
  ${author}
</blockquote>`;
          }
        });
      }
    </script>
  </body>
</html>